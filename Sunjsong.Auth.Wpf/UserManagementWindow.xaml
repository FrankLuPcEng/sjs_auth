<ui:FluentWindow x:Class="Sunjsong.Auth.WpfUI.UserManagementWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:ui="clr-namespace:Wpf.Ui.Controls;assembly=Wpf.Ui"
                 xmlns:uiMarkup="clr-namespace:Wpf.Ui.Markup;assembly=Wpf.Ui"
                 mc:Ignorable="d"
                 Title="{Binding WindowTitle}"
                 Height="720"
                 Width="1200"
                 WindowStartupLocation="CenterScreen"
                 WindowBackdropType="Mica"
                 ExtendsContentIntoTitleBar="True"
                 ResizeMode="CanResizeWithGrip">
    <ui:FluentWindow.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <uiMarkup:ThemesDictionary Theme="Light" />
                <uiMarkup:ControlsDictionary />
                <ResourceDictionary Source="themes/Modern.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        </ResourceDictionary>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ui:TitleBar Grid.Row="0" Title="{Binding WindowTitle}" />

        <Grid Grid.Row="1" Margin="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2.2*" />
                <ColumnDefinition Width="2.8*" />
            </Grid.ColumnDefinitions>

            <!-- Users -->
            <Border Grid.Column="0" Padding="14" CornerRadius="10" Background="#0F000000" Margin="0,0,12,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Grid.Row="0" VerticalAlignment="Center">
                        <TextBlock Text="使用者" FontSize="20" FontWeight="Bold" />
                        <ProgressBar Width="120"
                                     Height="8"
                                     VerticalAlignment="Center"
                                     Margin="8,0,0,0"
                                     Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     IsIndeterminate="True" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Grid.Row="1" Margin="0,8,0,0">
                        <Button Content="新增"
                                Width="90"
                                Command="{Binding AddUserCommand}" />
                        <Button Content="刪除"
                                Width="90"
                                Margin="8,0,0,0"
                                Command="{Binding DeleteUserCommand}" />
                        <Button Content="重新整理"
                                Width="110"
                                Margin="8,0,0,0"
                                Command="{Binding RefreshCommand}" />
                    </StackPanel>

                    <DataGrid Grid.Row="2"
                              ItemsSource="{Binding Users}"
                              SelectedItem="{Binding SelectedUser, Mode=TwoWay}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              SelectionMode="Single"
                              Margin="0,8,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Binding="{Binding Name}" Header="名稱" Width="2*" />
                            <DataGridTextColumn Binding="{Binding Id}" Header="Id" Width="*" />
                        </DataGrid.Columns>
                    </DataGrid>

                    <Grid Grid.Row="3" Margin="0,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0"
                                 Height="36"
                                 Padding="10,6"
                                 Text="{Binding SelectedUser.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        <Button Grid.Column="1"
                                Content="儲存"
                                Width="90"
                                Margin="8,0,0,0"
                                Command="{Binding SaveUserCommand}" />
                    </Grid>
                </Grid>
            </Border>

            <!-- Roles & Permissions -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Padding="14" CornerRadius="10" Background="#0F000000" Margin="0,0,0,12">
                    <StackPanel>
                        <TextBlock Text="為使用者指派角色" FontSize="18" FontWeight="Bold" />
                        <TextBlock Text="選取左側使用者後，勾選要賦予的角色。" Foreground="#99000000" Margin="0,4,0,0" />
                        <ScrollViewer Height="160" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
                            <ItemsControl ItemsSource="{Binding RoleSelections}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding Name}"
                                                  IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <Button Content="儲存角色指派"
                                    Width="150"
                                    Command="{Binding SaveUserRolesCommand}" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <Border Grid.Row="1" Padding="14" CornerRadius="10" Background="#0F000000">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1.3*" />
                            <ColumnDefinition Width="1.7*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.ColumnSpan="2"
                                   Text="角色與權限"
                                   FontSize="18"
                                   FontWeight="Bold" />

                        <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,8,0,0">
                            <StackPanel Orientation="Horizontal">
                                <Button Content="新增角色"
                                        Width="100"
                                        Command="{Binding AddRoleCommand}" />
                                <Button Content="刪除角色"
                                        Width="100"
                                        Margin="8,0,0,0"
                                        Command="{Binding DeleteRoleCommand}" />
                            </StackPanel>

                            <DataGrid ItemsSource="{Binding Roles}"
                                      SelectedItem="{Binding SelectedRole, Mode=TwoWay}"
                                      AutoGenerateColumns="False"
                                      HeadersVisibility="Column"
                                      RowHeaderWidth="0"
                                      IsReadOnly="False"
                                      SelectionMode="Single"
                                      Margin="0,8,0,0"
                                      Height="240">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                        Header="角色名稱"
                                                        Width="2*" />
                                    <DataGridTextColumn Binding="{Binding Id}"
                                                        Header="Id"
                                                        Width="*" />
                                </DataGrid.Columns>
                            </DataGrid>

                            <Button Content="儲存角色名稱"
                                    Width="140"
                                    Command="{Binding SaveRoleCommand}" />
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="1" Margin="12,8,0,0">
                            <TextBlock Text="為選取的角色勾選可用的權限" />
                            <Border BorderBrush="#22000000" BorderThickness="1" CornerRadius="8" Padding="6" Margin="0,6,0,0">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" Height="240">
                                    <ItemsControl ItemsSource="{Binding PermissionSelections}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}">
                                                    <StackPanel Orientation="Vertical" Margin="0,4">
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                        <TextBlock Text="{Binding Key}" FontSize="11" Foreground="#77000000" />
                                                    </StackPanel>
                                                </CheckBox>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                            <Button Content="儲存角色權限"
                                    Width="140"
                                    Margin="0,6,0,0"
                                    Command="{Binding SaveRolePermissionsCommand}" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <Border Grid.Row="2" Background="#0F000000" Padding="12,8" BorderBrush="#16000000" BorderThickness="1">
            <TextBlock Text="{Binding StatusMessage}" />
        </Border>
    </Grid>
</ui:FluentWindow>
